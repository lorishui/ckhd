package me.ckhd.opengame.user.web;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import me.ckhd.opengame.common.persistence.Page;
import me.ckhd.opengame.common.utils.MD5Util;
import me.ckhd.opengame.common.utils.StringUtils;
import me.ckhd.opengame.common.web.BaseController;
import me.ckhd.opengame.sys.service.SystemService;
import me.ckhd.opengame.user.entity.UserInfo;
import me.ckhd.opengame.user.service.UserInfoService;

import org.apache.shiro.authz.annotation.RequiresPermissions;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

@Controller
@RequestMapping({"${adminPath}/user/sdkUser"})
public class SDKUserController extends BaseController{

	@Autowired
	private UserInfoService userInfoService;

	@RequiresPermissions("user:sdkUser:view")
	@RequestMapping({"list", ""})
	public String list(UserInfo userInfo, HttpServletRequest request, HttpServletResponse response, Model model){
		Page<UserInfo> page = this.userInfoService.findPage(new Page<UserInfo>(request, response), userInfo);
		model.addAttribute("page", page);
		model.addAttribute("sdkUser", userInfo);
		return "modules/sdkUser/userList";
	}
  
	@RequiresPermissions("user:sdkUser:edit")
	@RequestMapping("form")
	public String form(UserInfo userInfo, Model model) {
		userInfo = (UserInfo)this.userInfoService.getOne(userInfo);
		model.addAttribute("userInfo", userInfo);
		return "modules/sdkUser/userForm";
	}
	
	@RequiresPermissions("user:sdkUser:edit")
	@RequestMapping("save")
	public String save(UserInfo userInfo, Model model,RedirectAttributes redirectAttributes,
			HttpServletRequest request,HttpServletResponse response) {
		if(StringUtils.isNotBlank(userInfo.getUserAccount()) && StringUtils.isNotBlank(userInfo.getPwd()) ){
			userInfo.setPwd(SystemService.entryptPassword(MD5Util.string2MD5(userInfo.getPwd())));
			userInfo.setIndex(getIndex(userInfo.getUserAccount().charAt(userInfo.getUserAccount().length()-1)));
			this.userInfoService.update(userInfo);
			addMessage(redirectAttributes, "修改密码成功");
		}else{
			addMessage(redirectAttributes, "修改密码失败");
		}
		return list(userInfo, request, response, model);
	}
	
	public String getIndex(char ch){
		StringBuffer sb = new StringBuffer();
		if(ch >=48 && ch <= 57 ){
			sb.append(ch);
		}else{
			int n=ch%10;
			sb.append(n);
		}
		return sb.toString();
	}
}