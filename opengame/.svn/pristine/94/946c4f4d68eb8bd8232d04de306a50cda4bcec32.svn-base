<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="me.ckhd.opengame.gamecode.dao.GameCodeDao">
	<sql id="GameCodeColumns">

	</sql>

	<sql id="GameCodeJoins">
		<!-- -->
	</sql>


	<!-- 根据id获得AdPush -->
	<select id="findGameCodeByCodeAndCkAppId" resultType="GameCode">
		SELECT
			id,
			ckAppId,
			code,
			status
		FROM t_gamecode 
		WHERE code = #{code}
		<if test="ckAppId != null and ckAppId != ''">
			AND ckAppId = #{ckAppId}
		</if>
		and status = '0';
	</select>
	
	<select id="get" resultType="GameCode">
		SELECT
			id,
			ckAppId,
			code,
			status
		FROM t_gamecode 
		WHERE id = #{id};
	</select>

	<!-- 分页查询GameCode信息 -->
	<select id="findList" resultType="GameCode">
		select 
			CONCAT(b.name,'(',a.ckAppID,')')as ckAppId ,
			a.code as code , 
			a.status as status
		from t_gamecode a 
		LEFT JOIN app_ck b 
		on a.ckAppID = b.ckapp_id
		where 1 = 1
		<if test="ckAppId != null and ckAppId != ''">
			AND a.ckAppId = #{ckAppId}
		</if>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.ckAppId
			</otherwise>
		</choose>
	</select>



	<!-- 查询全部AdPush -->
	<!-- <select id="findAllList" resultType="AdPush">
	SELECT
	<include refid="AdPushColumns" />
	FROM t_ad_push a WHERE a.del_flag = #{DEL_FLAG_NORMAL} ORDER BY
	a.create_time
	DESC
</select> -->


	<!-- 插入AdPush -->
	<insert id="insert">
		INSERT INTO t_gamecode(
			id,
			ckAppId,
			code,
			status,
			create_date,
			create_by
		) VALUES (
			#{id},
			#{ckAppId},
			#{code},
			#{status},
			#{createDate},
			#{createBy.id}
		)
	</insert>
	
	
	<select id="findAllCkApp" resultType="java.util.HashMap"> 
		SELECT 
		ckapp_id as appId, 
		CONCAT(name,'(',ckapp_id,')') as name
		FROM app_ck WHERE del_flag = '0'
	</select>
	
	<!-- <select id="getCodes" resultType="GameCode"> 
		SELECT
			id,
			ckAppId,
			code
		FROM t_gamecode 
		WHERE status = '0'
		limit 20
	</select> -->
	
	<select id="getCode" resultType="GameCode"> 
		SELECT
			id,
			ckAppId,
			code
		FROM t_gamecode 
		WHERE status = '0'
		<if test=" ckAppId != null and ckAppId != ''">
			AND ckAppId = #{ckAppId}
		</if>
		limit #{randomInt},1
	</select>
	
	<update id="delete">
		UPDATE t_gamecode set
		status = '1'
		WHERE id = #{id}
		and status = '0';
	</update>
	
	<insert id="log">
		INSERT INTO t_gamecode_log(
			id,
			ckapp_id,
			code,
			phone_num,
			date,
			status
		) VALUES (
			#{id},
			#{ckAppId},
			#{code},
			#{phoneNum},
			#{date},
			#{status}
		)
	</insert>
	
	<!-- 分页查询GameCode信息 -->
	<select id="checkPhoneNum" resultType="GameCodeLog">
		SELECT
			id,
			ckapp_id as ckAppId,
			code,
			phone_num as phoneNum,
			date,
			status
		FROM t_gamecode_log
		WHERE status = '0'
		<if test=" phoneNum != null and phoneNum != ''">
			AND phone_num = #{phoneNum}
		</if>
		<if test=" ckAppId != null and ckAppId != ''">
			AND ckapp_id = #{ckAppId}
		</if>
		<if test="startDate != null and startDate != ''">
			AND date <![CDATA[ >= ]]> #{startDate}
		</if>
		<if test="endDate != null and endDate != ''">
			AND date <![CDATA[ <= ]]> #{endDate}
		</if>
	</select>	

</mapper>