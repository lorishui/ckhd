<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="me.ckhd.opengame.app.dao.PaymentWayDao">
    <sql id="paymentWayColumns">
        a.id,
        a.ckapp_id,
        a.carriers,
    	a.app_ids as "appIds",
    	substring_index(a.app_ids,',',1) as mmAppId,
    	substring_index(a.app_ids,',',-1)  as andgameAppId,
    	a.channel_id,
    	b.name as "channelName",
		a.province_code,
		d.label as "provinceName",
		a.pay_way_sign,
		a.version,
		a.remarks,
		a.del_flag
    </sql>
    
    <sql id="paymentWayJoins">
        <!-- -->
        left join  channel b on b.id=a.channel_id
        left join  sys_dict d on  d.type='province_iccid' and d.value=a.province_code  
    </sql>
	
	<!-- 根据id获得支付通道配置 -->
	<select id="get" resultType="PaymentWay">
		SELECT
			<include refid="paymentWayColumns"/> 
		FROM app_payway a
			<include refid="paymentWayJoins"/> 
		WHERE a.id = #{id}
	</select>
	
	<!-- 分页查询支付通道配置信息 -->
	<select id="findList" resultType="PaymentWay">
		SELECT
			<include refid="paymentWayColumns"/>
		FROM  app_payway a
			<include refid="paymentWayJoins"/> 
		WHERE 1=1 
		<if test="appIds != null and appIds != ''">
			AND a.app_ids like CONCAT('%', #{appIds}, '%')
		</if>
		<if test="channelId != null and channelId != ''">
			AND a.channel_id = #{channelId} 
		</if>
		<if test="version != null and version != ''">
			AND a.version = #{version}
		</if>
		 <if test="provinceCode != null and provinceCode != ''">
			AND a.province_code like CONCAT('%', #{provinceCode}, '%') 
		</if>
		<if test="carriers != null and carriers != ''">
			AND a.carriers = #{carriers}
		</if>
		<if test="ckappId != null and ckappId != ''">
			AND a.ckapp_id = #{ckappId}
		</if>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.app_ids
			</otherwise>
		</choose>
	</select>
	
	 
	
	<!-- 查询全部支付通道配置 -->
	<select id="findAllList" resultType="PaymentWay">
		SELECT
			<include refid="paymentWayColumns"/>
		FROM  app_payway a
	</select>
	
	<!-- 查询全部支付通道配置数目 -->
	<select id="findAllCount" resultType="long">
		SELECT
			COUNT(1)
		FROM  app_payway a
	</select>
	
	<!-- 插入支付通道配置 -->
	<insert id="insert">
		INSERT INTO app_payway(
			id,
			ckapp_id,
			carriers,
		    app_ids,
		    version,
			channel_id,
			province_code,
			pay_way_sign,
			del_flag,
			remarks
		) VALUES (
		    #{id},
		    #{ckappId},
		    #{carriers},
			#{appIds}, 
			#{version}, 
			#{channelId}, 
			#{provinceCode}, 
			#{payWaySign}, 
			#{delFlag},
			#{remarks} 
		)
	</insert>
	<!-- 更新支付通道配置信息  -->
	<update id="update">
		UPDATE  app_payway SET 
			pay_way_sign = #{payWaySign}, 
			del_flag = #{delFlag},
			version = #{version},
			channel_id = #{channelId},
			province_code = #{provinceCode},
			remarks = #{remarks}
		WHERE id = #{id}
	</update>
	<!-- 删除支付通道配置 -->
	<update id="delete">
		delete from app_payway WHERE id = #{id}
	</update>
	<!-- '0'表示默认方式 -->
	<select id="paywayList" resultType="java.util.HashMap">
		select concat('version_',version,',channel_id_',channel_id,',province_code_',province_code) as 'key',pay_way_sign from app_payway where carriers=#{carriers} and substring_index(app_ids,',',1)=#{appIds} and del_flag= '0'
		union all
		select concat('province_code_',province_code,',version_',version) as 'key',pay_way_sign from app_payway where carriers=#{carriers} and substring_index(app_ids,',',1)=#{appIds} and channel_id='' and del_flag= '0';
	</select>
</mapper>