package me.ckhd.opengame.online.version;

import java.util.Date;
import java.util.Map;
import java.util.Random;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import me.ckhd.opengame.app.entity.APPCk;
import me.ckhd.opengame.app.entity.PayCodeConfig;
import me.ckhd.opengame.app.entity.PayInfoConfig;
import me.ckhd.opengame.app.utils.AppCkUtils;
import me.ckhd.opengame.common.utils.DateUtils;
import me.ckhd.opengame.common.utils.SpringContextHolder;
import me.ckhd.opengame.online.entity.OnlinePay;
import me.ckhd.opengame.online.entity.OnlineUser;
import me.ckhd.opengame.online.handle.BaseHandle;
import me.ckhd.opengame.online.sendOrder.task.OrderSenderBoot;
import me.ckhd.opengame.online.service.OnlineService;
import me.ckhd.opengame.online.util.OrderStatus;
import me.ckhd.opengame.user.utils.RedisClientTemplate;

import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.alibaba.fastjson.JSONObject;

@Service("onlineVersion110")
public class OnlineVersion110 extends Version{
	
	@Autowired
	public OnlineService onlineService;
	
	@Autowired
	public RedisClientTemplate redisClientTemplate;
	
	//pay start
	@Override
	public String pay(JSONObject codeJson,HttpServletRequest request) {
		String engName = codeJson.getString("a");
		JSONObject result = new JSONObject();
		String resultStr = null;
		OnlinePay onlinePay = null;
		try{
			String ckAppid = codeJson.containsKey("ckAppId")?codeJson.getString("ckAppId"):null;
			String ckChannelId = codeJson.containsKey("ckChannelId")?codeJson.getString("ckChannelId"):null;
			String productId = codeJson.containsKey("productId")?codeJson.getString("productId"):null;
			if( ckAppid == null || ckChannelId == null || productId == null ){
				result.put("resultCode", 3001);
				result.put("errMsg", "必要参数缺失");
				throw new Exception("3001");
			}
			//获取游戏信息
			APPCk appck = AppCkUtils.getAppCkById(ckAppid);
			if(appck==null){
				result.put("resultCode", 3002);
				result.put("errMsg", "游戏不存在");
				throw new Exception("3002");
			}
			//获取已配置的计费点信息
			PayCodeConfig payCodeConfig = getPayCodeConfig(codeJson);
			if( payCodeConfig == null ){
				result.put("resultCode", 3003);
				result.put("errMsg", "未配置计费点信息");
				throw new Exception("3003");
			}
			String price = codeJson.containsKey("prices")?codeJson.getString("price"):null;
			// ### 网游的金额使用服务器的配置
			if( "141".equals(codeJson.get("payType")) ){
				price = payCodeConfig.getPrice();
			}
			String year=DateUtils.formatDateToStr("YYMMdd");
			//获取Order id
			Integer orderId = onlineService.getOrderId(ckAppid);
			//创建订单对象
			onlinePay = getOnliePay(codeJson,orderId,year,appck,price);
			BaseHandle handle = getHandle(engName);
			if( handle != null ){
				resultStr = handle.pay(onlinePay, codeJson);
			}else{
				result.put("resultCode", 2011);
				result.put("errMsg", "请求的内容不存在!");
			}
		}catch (Throwable e) {
			logger.error("下单失!!!! ", e.getMessage());
			if( result.size()  == 0){
				result.put("resultCode", 3004);
				result.put("errMsg", "内部错误");
			}
		}finally{
			if(onlinePay!=null){
				// 将服务器获取到的数据保存到数据库
				onlineService.savePayInfo(onlinePay);
			}
		}
		if( StringUtils.isBlank(resultStr) ){
			resultStr = result.toJSONString();
		}
		logger.info(String.format("支付返回客户端的数据:[%s]", resultStr));
		return resultStr;
	}
	
	public PayCodeConfig getPayCodeConfig(JSONObject condeJson){
		PayCodeConfig payCodeConfig = new PayCodeConfig();
		payCodeConfig.setCkAppId(condeJson.containsKey("ckAppId")?condeJson.getString("ckAppId"):"");
		payCodeConfig.setChannelId(condeJson.containsKey("ckChannelId")?condeJson.getString("ckChannelId"):"");
/*		if( condeJson.containsKey("payType") && StringUtils.isNotBlank(condeJson.getString("payType")) ){
			Integer payType = Integer.valueOf(condeJson.getString("payType"));
			payCodeConfig.setPaytype("141");
		}else{
			payCodeConfig.setPaytype("");
		}*/
		payCodeConfig.setPaytype("141");
		if( condeJson.containsKey("productId") && StringUtils.isNotBlank(condeJson.getString("productId")) ){
			payCodeConfig.setProductId(condeJson.containsKey("productId")?condeJson.getString("productId"):"");
			return onlineService.getPayCode(payCodeConfig);
		}else{
			return null;
		}
	}
	
	public OnlinePay getOnliePay(JSONObject codeJson,Integer orderId,String year,APPCk appCk,String price){
		OnlinePay onlinePay = new OnlinePay();
		String channelId = codeJson.getString("ckChannelId");
		onlinePay.setChannelId(codeJson.getString("ckChannelId"));
		onlinePay.setCkAppId(codeJson.getString("ckAppId"));
		onlinePay.setAppId(codeJson.containsKey("appId")?codeJson.getString("appId"):"");
		onlinePay.setVersion(codeJson.containsKey("version")?codeJson.getString("version"):"");
		onlinePay.setPayType(codeJson.containsKey("payType")?codeJson.getString("payType"):"");
		onlinePay.setExtension(codeJson.containsKey("extension")?codeJson.getString("extension"):"");
		onlinePay.setGameOnline(codeJson.containsKey("gameOnline")?codeJson.getInteger("gameOnline"):0);
		if( price != null ){
			int prices = Integer.valueOf(price);
			double d = prices*appCk.getDiscount();
			onlinePay.setPrices((int)d);
		}else{
			onlinePay.setPrices(0);
		}
		onlinePay.setUserId(codeJson.containsKey("userId")?codeJson.getString("userId"):"");
		onlinePay.setProductId(codeJson.containsKey("productId")?codeJson.getString("productId"):"");
		onlinePay.setAppPayContent(codeJson.toJSONString());
		onlinePay.setSdkType(codeJson.containsKey("sdkType")?codeJson.getString("sdkType"):"");
		if(codeJson.containsKey("payNotifyUrl")){
			onlinePay.setCallBackUrl(codeJson.getString("payNotifyUrl"));
		}else if(codeJson.containsKey("callBackUrl")){
			onlinePay.setCallBackUrl(codeJson.getString("callBackUrl"));
		}
		onlinePay.setOrderStatus(OrderStatus.NON_PAYMENT);
		onlinePay.setOrderId(genOderId(orderId,onlinePay.getCkAppId(),year));
		onlineService.savePayInfo(onlinePay);
		if(channelId != null && "2".equals(onlinePay.getSdkType()) && 
				("22".equals(channelId) || "23".equals(channelId) || 
						"24".equals(channelId) || "25".equals(channelId) )){
			onlinePay.setOrderIndex(saveIndex(channelId, 0, onlinePay.getOrderId())+"");
		}
		return onlinePay;
	}
	
	private int saveIndex(String channelId,int index,String orderId){
		int orderIndex=0;
		try {
			orderIndex = onlineService.saveOrderIndex(orderId);
		} catch (Exception e) {
			if (index<3) {
				orderIndex=saveIndex(channelId,index++,orderId);
			}else{
				throw e;
			}
		}
		return orderIndex;
	}
	
	private String genOderId(int orderId,String ckAppId,String year) {
		StringBuffer strBuff = new StringBuffer();
		// 游戏编号超过1099修改，改成36进制，相当于1099对应"99",1100对应"9a" update@2016-12-26
		String appCode = null;
		if (ckAppId.startsWith("10")) {
			appCode = ckAppId.substring(ckAppId.length()-2);
		} else {
			int y = Integer.parseInt(ckAppId);
			// 36进制100等于334（增加334-100 = 234）
			y = y - 1000 + 234;
			appCode = Integer.toString(y, Character.MAX_RADIX);
		}
		// update@2016-12-26 end
		strBuff.append(appCode);
		strBuff.append(year);

		String orderStr = "000000" + Integer.toHexString(orderId);
		orderStr = orderStr.substring(orderStr.length() - 6);
		strBuff.append(orderStr);//序号 
		
		Random random = new Random();
		strBuff.append(String.valueOf(10+random.nextInt(90)));
		return strBuff.toString();
	}
	//pay end
	
	//login登录开始
	@Override
	public String login(JSONObject codeJson, HttpServletRequest request) {
		String engName = codeJson.getString("c");
		JSONObject json = new JSONObject();
		// 获取已配置支付信息
		PayInfoConfig payInfo = getLoginInfo(codeJson);
		String resultStr = null;
		if(payInfo==null){
			json.put("resultCode", 2010);
			json.put("errMsg", "网游基本信息未配置!");
		}else{
			OnlinePay onlinePay = new OnlinePay();
			onlinePay.setPayInfoConfig(payInfo);
			BaseHandle handle = getHandle(engName);
			if( handle != null ){
				OnlineUser user = new OnlineUser();
				resultStr = handle.login( user, codeJson, payInfo);
				JSONObject result = JSONObject.parseObject(resultStr);
				if( result.getInteger("resultCode") == 0){
					OnlineUser oldUser = onlineService.get(user);
					if (oldUser != null) {
						user.setUid(oldUser.getUid());
						user.setUpdateDate(new Date());
					}
					// 将服务器获取到的数据保存到数据库
					onlineService.saveUserInfo(user);
				}
			}else{
				json.put("resultCode", 2011);
				json.put("errMsg", "请求的内容不存在!");
			}
		}
		if( StringUtils.isBlank(resultStr) ){
			resultStr = json.toJSONString();
		}
		logger.info(String.format("返回客户端的数据0:[%s]", resultStr));
		return json.toJSONString();
	}
	
	/**
	 * 获取登录的参数
	 * @param map
	 * @return
	 */
	public PayInfoConfig getLoginInfo(JSONObject codeJson) {
		PayInfoConfig payInfo = new PayInfoConfig();
		payInfo.setCkAppId(codeJson.containsKey("ckAppId")?codeJson.getString("ckAppId"):"");
		payInfo.setChannelId(codeJson.containsKey("ckChannelId")?codeJson.getString("ckChannelId"):"");
		payInfo.setCarrierAppId(codeJson.containsKey("sdkVersion")?codeJson.getString("sdkVersion"):"");
		return  onlineService.getLoginInfo(payInfo);
	}
	//login登陆结束
	
	@Override
	public String callback(String code,String engName,HttpServletRequest request,HttpServletResponse response) {
		JSONObject json = new JSONObject();
		String returnStr = null;
		OnlinePay newPay = null;
		OnlinePay onlinePay = null;
		boolean isSuccess = false;
		try {
			//处理逻辑
			BaseHandle handle = SpringContextHolder.getBean(engName);
			onlinePay = new OnlinePay();
			handle.parseParamter(code, request,onlinePay);
			if(StringUtils.isNotBlank(onlinePay.getOrderId())){
				//百度处理
				if("baidu".equals(engName)){
					newPay = onlineService.getOrderById(onlinePay.getOrderId());
				}else{
					newPay = onlineService.getOrderByOrderId(onlinePay.getOrderId());
				}
			}else if(StringUtils.isNotBlank(onlinePay.getChannelOrderId())){
				newPay = onlineService.getOrderByChannelOrderIdOther(onlinePay.getChannelOrderId());
				if(newPay == null){
					newPay = onlineService.getOrderByPrepayid(onlinePay.getChannelOrderId());
					if(newPay == null){
						logger.info(String.format("外部订单号订为[%s]的订单不存在!", onlinePay.getChannelOrderId()));
						json.put("resultCode", 4003);
						json.put("errMsg", "无效订单");
						throw new Exception();
					}
				}
			}else{
				json.put("resultCode", 4004);
				json.put("errMsg", "无法定位记录");
				throw new Exception();
			}
			//已成功的订单处理
			if(OrderStatus.PAY_SUCCESS.equals(newPay.getOrderStatus())){
				returnStr = handle.getReturnSuccess();
				throw new Exception();
			}
			//获取计费点信息
			PayCodeConfig payCodeConfig = getPayCodeConfig(newPay);
			newPay.setPayCodeConfig(payCodeConfig);
			PayInfoConfig payInfoConfig = getPayInfoConfig(newPay);
			newPay.setPayInfoConfig(payInfoConfig);
			JSONObject result = new JSONObject();
			returnStr = handle.verifyData(newPay,result,response);
			if( result.getInteger("code") == 2000){
				newPay.setProductName(payCodeConfig==null?null:payCodeConfig.getProductName());
				APPCk appCk =AppCkUtils.getAppCkById(newPay.getCkAppId());
				//5.判断是否为网游或者是否配置下发地址,如果非网游或者没有设置下发地址则不下发,反之下发到游戏
				if( StringUtils.isNotBlank(appCk.getPayCallbackUrl()) || StringUtils.isNotBlank(newPay.getCallBackUrl()) ){
					newPay.setSercetKey(appCk.getSecretKey());
					Map<String, Object> map = handle.getSendOrder(newPay);
					newPay.setSendNum(Integer.valueOf(map.get("sendNum")==null?"0":map.get("sendNum").toString()));
					newPay.setActualAmount(onlinePay.getActualAmount());
					newPay.setOrderStatus(OrderStatus.PAY_SUCCESS);
					newPay.setSendStatus(OrderStatus.SEND_DOWN_ING);
					newPay.setErrMsg("");
					newPay.setContent(map.get("content").toString());
					onlineService.savePayInfo(newPay);
					isSuccess = true;
					//加入发货队列
					OrderSenderBoot.getInstance().add(newPay);
				}else{
					newPay.setOrderStatus(OrderStatus.PAY_SUCCESS);
					newPay.setErrMsg("");
					newPay.setCallBackContent(code);
					newPay.setActualAmount(onlinePay.getActualAmount());
					newPay.setChannelOrderId(newPay.getChannelOrderId());
				}
			}else{
				onlinePay.setOrderStatus(OrderStatus.PAY_FAIL);
				onlinePay.setCallBackContent(code);
				returnStr = handle.getReturnFailure();
				throw new Exception();
			}
		} catch (Exception e) {
			if( json.size() == 0 ){
				json.put("resultCode", 4002);
				json.put("errMsg", "内部错误");
			}
			logger.info("支付异常提示："+json.toJSONString());
			logger.error("支付发生错误：",e);
		}finally{
			//出错的保存或单机成功的保存
			if( newPay != null && StringUtils.isNotBlank(newPay.getId()) && !isSuccess){
				newPay.setActualAmount(onlinePay.getActualAmount());
				newPay.setCallBackContent(onlinePay.getCallBackContent());
				newPay.setErrMsg(StringUtils.isNotBlank(returnStr)?returnStr:json.toJSONString());
				onlineService.savePayInfo(newPay);
			}
		}
		if( returnStr == null ){
			returnStr = json.toJSONString();
		}
		logger.info(String.format("返回渠道的数据%s:[%s]",engName, returnStr));
		return returnStr;
	}
	
	public PayCodeConfig getPayCodeConfig(OnlinePay onlinePay){
		PayCodeConfig payCodeConfig = new PayCodeConfig();
		payCodeConfig.setCkAppId(onlinePay.getCkAppId());
		payCodeConfig.setChannelId(onlinePay.getChannelId());
		payCodeConfig.setPaytype("141");
		payCodeConfig.setProductId(onlinePay.getProductId());
		return onlineService.getPayCode(payCodeConfig);
	}
	
	public PayInfoConfig getPayInfoConfig(OnlinePay onlinePay){
		PayInfoConfig payInfo=new PayInfoConfig();
		payInfo.setCkAppId(onlinePay.getCkAppId());
		payInfo.setPaytype(onlinePay.getPayType());
		payInfo.setChannelId(onlinePay.getChannelId());
		return onlineService.getPayInfo(payInfo);
	}
	
	/**
	 *通过bean.name 获取对象
	 * 
	 * @param className
	 * @param code
	 * @return
	 */
	private BaseHandle getHandle(String engName) {

		BaseHandle BaseHandle = null;
		try {
			BaseHandle = (BaseHandle) SpringContextHolder.getBean(engName);
		} catch (Throwable e) {
			logger.error("spring获取bean出问题!!!!", e);
		}
		return BaseHandle;
	}
	
}
