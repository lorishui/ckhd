<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="me.ckhd.opengame.app.dao.PayRulesDao">
    
    <!-- 意图想通过获得payRules中的所有payRulesConfig,此处相当于one2many -->  
    <resultMap type="PayRules" id="getPayRulesAndConfig">  
        <id column="prId" property="id"/>
        <result column="ckappid"  property="ckappId"/>
        <result column="appid" property="appid"/>
        <result column="channelId" property="channelId"/>
        <result column="startTime" property="startTime"/>  
        <result column="endTime" property="endTime"/>
        <result column="internetPay" property="internetPay"/>
        <result column="version" property="version"/>
        <collection property="configs" ofType="me.ckhd.opengame.app.entity.PayRulesConfig" column="pr_id">  
            <id column="id" property="id"/>
            <result column="pr_id" property="pr_id"/>
            <result column="provinceids" property="provinceids"/>  
            <result column="carriers" property="carriers"/>
            <result column="money" property="money"/>
            <result column="totalmoney" property="totalmoney"/>
            <result column="label" property="carriersName"/>   
        </collection>  
    </resultMap>
    
    <!-- lable不需要 -->
    <resultMap type="PayRules" id="getPayRulesAndConfig2">  
        <id column="prId" property="id"/>
        <result column="ckappid"  property="ckappId"/>
        <result column="appid" property="appid"/>
        <result column="channelId" property="channelId"/>
        <result column="internetPay" property="internetPay"/>
        <result column="version" property="version"/>
        <collection property="configs" ofType="me.ckhd.opengame.app.entity.PayRulesConfig" column="pr_id">  
            <id column="id" property="id"/>
            <result column="pr_id" property="pr_id"/>
            <result column="provinceids" property="provinceids"/>  
            <result column="carriers" property="carriers"/>
            <result column="money" property="money"/>
            <result column="totalmoney" property="totalmoney"/>
        </collection>  
    </resultMap>
    
    <select id="getRulesAndConfig" resultMap="getPayRulesAndConfig">
        select a.id as prId,a.ckappid,a.appid,a.channelid,a.version,DATE_FORMAT(a.startTime,'%Y-%m-%d %H:%i') startTime,DATE_FORMAT(a.endTime,'%Y-%m-%d %H:%i') endTime,a.internetPay,b.*,c.* 
		from app_payrules a 
        LEFT join (Select * from app_payrules_config where del_flag='0') b on b.pr_id =a.id
        left join (Select * from sys_dict where type='sdkType') c on c.value=b.carriers
        where 1=1 and a.del_flag='0' and a.id=#{id} order by a.startTime,a.endTime,b.create_date desc
    </select>
    
    <select id="getAllRulesAndConfig" resultMap="getPayRulesAndConfig">
        select a.id as prId, ckappid,a.appid,a.channelid,a.version,DATE_FORMAT(a.startTime,'%Y-%m-%d %H:%i') startTime,DATE_FORMAT(a.endTime,'%Y-%m-%d %H:%i') endTime,a.internetPay,b.*,c.* 
		from app_payrules a 
        LEFT join (Select * from app_payrules_config where del_flag='0') b on b.pr_id =a.id
        left join (Select * from sys_dict where type='sdkType') c on c.value=b.carriers
        where 1=1 and a.del_flag='0' order by a.startTime,a.endTime,b.create_date desc
    </select>
    
    <select id="getRulesAndConfigByTime" resultMap="getPayRulesAndConfig2">
        select a.id as prId, ckappid,a.appid,a.channelid,a.version,a.internetPay,b.id,b.provinceids,b.carriers,b.money,b.totalmoney
		from app_payrules a 
        LEFT join (Select * from app_payrules_config where del_flag='0') b on b.pr_id =a.id
        where a.ckappid=#{ckappId} and a.del_flag='0' 
        and 
        (
         IF (a.endTime,
			(SYSDATE() BETWEEN a.startTime and a.endTime),
			(SYSDATE()>a.startTime))
		) 
		order by a.startTime,a.endTime,b.create_date desc
    </select>
    
     <select id="getAllRulesAndConfigByTime" resultMap="getPayRulesAndConfig">
        select a.id as prId, ckappid,a.appid,a.channelid,a.version,DATE_FORMAT(a.startTime,'%Y-%m-%d %H:%i') startTime,DATE_FORMAT(a.endTime,'%Y-%m-%d %H:%i') endTime,a.internetPay,b.*,c.*  
		from app_payrules a 
        LEFT join (Select * from app_payrules_config where del_flag='0') b on b.pr_id =a.id
       	left join (Select * from sys_dict where type='sdkType') c on c.value=b.carriers
        where 1=1 and a.del_flag='0'
        <if test="id !=null and id !=''">
             and a.id = #{id} 
        </if>
        <if test="ckappId != null and ckappId != ''">
			 and a.ckappid=#{ckappId}
		</if>
		<if test="channelId != null and channelId != ''">
			 and a.channelId=#{channelId}
		</if>
        and 
        (
	        if(a.endTime,
	        	(SYSDATE() BETWEEN a.startTime and a.endTime),
	        	(SYSDATE()>a.startTime)
	        )
        )
         order by a.startTime,a.endTime,b.create_date desc
    </select>
    
   	<sql id="payRulesColumns">
		a.id,
		DATE_FORMAT(a.startTime,'%Y-%m-%d %H:%i') as startTime,
		DATE_FORMAT(a.endTime,'%Y-%m-%d %H:%i') as endTime,
		a.ckappid as ckappId,
		a.version,
		a.channelId,
		a.appid,
		c.app_name as appname,
		b.name as channelName,
		app.name as ckAppName,
		a.internetPay
   	</sql>
   	 <sql id="payRulesJoins">
        left join  channel b on b.id=a.channelId and b.`del_flag`='0'
        left join app_ck app on app.ckapp_id=a.ckappid  and app.del_flag='0'
        left join app_carriers c on c.app_id=a.appid  and c.del_flag='0'
    </sql>
    
   	 <!-- 新增支付通道切换配置 -->
   	<insert id="insert">
   	    insert into app_payrules(
   	    	id,
   	    	startTime,
            <if test="endTime != null and endTime != ''">  
               endTime,
            </if>
   	    	ckappid,
   	    	appid,
   	    	version,
   	    	channelId,
   	    	internetPay,
   	    	create_date,
   	    	create_by,
   	    	update_date,
   	    	update_by,
   	    	del_flag,
   	    	remarks
   	    ) values(
   	    	#{id},
   	    	#{startTime},
   	    	<if test="endTime != null and endTime != ''">  
              #{endTime},
            </if>
   	    	#{ckappId},
   	    	#{appid},
   	    	#{version},
   	    	#{channelId},
   	    	#{internetPay},
   	    	#{createDate},
   	    	#{createBy.id},
   	    	#{updateDate},
   	    	#{updateBy.id},
   	    	#{delFlag},
   	    	#{remarks}
   	    );
   	</insert>
   	
   	<!-- 分页获取数据 -->
   	<select id="findList" resultType="payRules">
   	    select 
			<include refid="payRulesColumns"/> 
   	    from app_payrules a 
			<include refid="payRulesJoins"/>
		WHERE 1=1 
		and a.del_flag= '0'
		<if test="ckappId != null and ckappId != ''">
			AND a.ckappid = #{ckappId} 
		</if>
		<if test="appid != null and appid != ''">
			AND a.appid = #{appid} 
		</if>
		<if test="channelId != null and channelId != ''">
			AND a.channelId = #{channelId} 
		</if>
		<if test="startTime != null and startTime != ''">
			AND (
			<if test="endTime != null and endTime != ''">
			    IF (a.endTime,
				(
					(#{startTime} BETWEEN a.startTime AND a.endTime) 
					or 
					(#{endTime} BETWEEN a.startTime and a.endTime)
					or
					(a.startTime BETWEEN #{startTime} and #{endTime})
					or
					(a.endTime BETWEEN #{startTime} and #{endTime})
				),
					a.startTime BETWEEN #{startTime} and #{endTime}
				)
			</if>
			<if test="endTime == null or endTime == ''">
			    IF (a.endTime,
				(
					a.startTime >= #{startTime}
					OR #{startTime} BETWEEN a.startTime AND a.endTime
				),
				'1=1'
				)
				
			</if>
			)
		</if>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.startTime,a.endTime 
			</otherwise>
		</choose>
   	</select>
   	
   	<!-- 根据id获得支付通道切换 -->
	<select id="get" resultType="payRules">
		SELECT
			<include refid="payRulesColumns"/> 
		FROM app_payrules a
			<include refid="payRulesJoins"/>
		WHERE a.id = #{id} and a.del_flag= '0'
	</select>
   	
   	<!-- 更新支付通道切换配置 -->
   	<update id="update">
   	    update app_payrules set
   	   		<choose>  
	            <when test="startTime == null or startTime == ''">  
	               startTime = null,
	            </when >
	            <otherwise>
	               startTime = #{startTime},
	            </otherwise>
            </choose>
			<choose>  
	            <when test="endTime == null or endTime == ''">  
	               endTime = null,
	            </when >
	            <otherwise>
	                endTime = #{endTime},
	            </otherwise>
            </choose>
   	    	
   	    	appid = #{appid},
   	    	channelId = #{channelId},
   	    	version = #{version},
   	    	internetPay = #{internetPay},
   	    	update_date = #{updateDate},
   	    	update_by = #{updateBy.id}
   	    	where id = #{id}
   	</update>
   	
   	
   	<select id="checkByTime" resultType="payRules">
   	    SELECT 
   	    	<include refid="payRulesColumns"/> 
   	    from app_payrules a 
   	    	<include refid="payRulesJoins"/>
		where 1=1 and a.del_flag= '0' 
		and a.ckappid=#{ckappId} 
		and a.channelId = #{channelId} 
		and a.appid = #{appid}
		and a.version = #{version}
		<if test="startTime != null and startTime != ''">
			AND (
			<if test="endTime != null and endTime != ''">
			    IF (a.endTime,
				(
					(#{startTime} BETWEEN a.startTime AND a.endTime) 
					or 
					(#{endTime} BETWEEN a.startTime and a.endTime)
					or
					(a.startTime BETWEEN #{startTime} and #{endTime})
					or
					(a.endTime BETWEEN #{startTime} and #{endTime})
				),
					a.startTime BETWEEN #{startTime} and #{endTime}
				)
			</if>
			<if test="endTime == null or endTime == ''">
			    IF (a.endTime,
				(
					a.startTime >= #{startTime}
					OR #{startTime} BETWEEN a.startTime AND a.endTime
				),
				'1=1'
				)
				
			</if>
			)
		</if>
   	</select>
   	
   	<update id="delete">
		update app_payrules set del_flag = '1'   
		WHERE id = #{id}
	</update>
	
   	<update id="saveInternetPay">
   	    update app_payrules set internetPay = #{internetPay} where id = #{id}
   	</update>
</mapper>