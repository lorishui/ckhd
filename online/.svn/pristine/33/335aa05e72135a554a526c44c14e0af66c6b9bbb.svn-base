<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="me.ckhd.opengame.stats.dao.StatRelatedDao">
	
	<select id="statsByChannelPaycode" resultType="java.util.HashMap">
		SELECT 
			p.ckAppId,
			p.childCkAppId,
		    p.channelId,
		    p.productid,
		    (SELECT c.NAME 
						FROM app_online_paycode c 
						WHERE c.channelid = p.channelId AND c.ckappid = p.ckAppId AND c.productid = p.productid
			union SELECT c. NAME 
						FROM app_online_paycode c 
						WHERE c.channelid ='' 
						AND c.ckappid = p.ckAppId 
						AND c.productid = p.productid 
						AND c.paytype = p.paytype
						limit 0,1
			 ) AS paycode_name, 
		    COUNT(0) AS total_num,
		    COUNT( CASE 
		 		WHEN p.orderStatus = '3' 
		 		THEN 1 
		 		ELSE NULL 
		 		END ) AS succ_num,
		     SUM(p.actualAmount) / 100 
			 AS actualAmount, 
			 SUM(CASE 
			 	WHEN p.orderstatus = '3' 
			 	THEN p.actualAmount 
			 	ELSE 0 
			 	END ) / 100 AS succ_actual 
		 FROM app_online_pay p 
		 WHERE  isTest = #{isTest}
			<if test="ckAppId != null and ckAppId != ''">
				and ckAppid=#{ckAppId}
			</if>
			<if test="childCkAppId != null and childCkAppId != ''">
				and childCkAppId=#{childCkAppId}
			</if>
			<if test="channelId != null and channelId != ''">
				AND channelid = #{channelId}
			</if>
			<if test="payType != null and payType != ''">
				AND payType = #{payType}
			</if>
			<if test="appId != null and appId != ''">
				AND appId = #{appId}
			</if>
			and create_date BETWEEN #{startDate} AND #{endDate}
		GROUP BY p.channelId,p.childCkAppId, p.productid ,p.ckAppId
	</select>
	
</mapper>