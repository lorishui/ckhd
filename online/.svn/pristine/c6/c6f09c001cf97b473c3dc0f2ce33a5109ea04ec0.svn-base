<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="me.ckhd.opengame.buyflow.dao.BuyFlowTotalIncomeStatsDao">

	<select id="queryTotalIncome" resultType="java.util.HashMap">
        SELECT
            <if test="statsDate == -1">
                CONCAT(ckapp_id, '_', child_ckapp_id, '_', media, '_', ad_item) AS `key`,
            </if>
             <if test="group == 1">
                CONCAT(ckapp_id, '_', child_ckapp_id, '_', media, '_', ad_item, '_',stats_date) AS `key`,
            </if>
        sum(CASE WHEN days = 0 THEN income ELSE 0 END) as totalIncome0,
        sum(CASE WHEN days <![CDATA[<=]]> 1 THEN income ELSE 0 END) as totalIncome1,
        sum(CASE WHEN days <![CDATA[<=]]> 7 THEN income ELSE 0 END) as totalIncome7,
        sum(CASE WHEN days <![CDATA[<=]]> 30 THEN income ELSE 0 END) as totalIncome30,
        sum(CASE WHEN days <![CDATA[<=]]> 60 THEN income ELSE 0 END) as totalIncome60
        FROM buy_flow_total_income_stats
        WHERE stats_date >= #{startDate} AND stats_date <![CDATA[<=]]> #{endDate}
         group by
        ckapp_id,child_ckapp_id,media,ad_item
        <if test="statsDate != -1">
	        ,stats_date;
        </if>
       
	</select>
	
	<select id="queryIncomeData" resultType="java.util.HashMap">
	     select 
	       <choose>
	           <when test="statsDate == -1">
	                <if test="group == 0">
                        CONCAT(a.media) as 'key',
                    </if>
                     <if test="group == 1">
                        CONCAT(c.name) as 'key',
                    </if>
	           </when>
	           <otherwise>
			       <if test="group == 0">
		                CONCAT(a.stats_date,'_',a.media) as 'key',
		            </if>
		             <if test="group == 1">
		                CONCAT(a.stats_date,'_',c.name) as 'key',
		            </if>
	           
	           </otherwise>
	       </choose>
            SUM(if(a.days <![CDATA[<=]]> 60,a.income,0)) as retainTotalIncome,
            SUM(if(a.days = 0,a.income,0)) as retainIncome,
            SUM(if(a.days = 0,a.device_num,0)) as payDevice,
            SUM(b.income) as totalIncome,
            SUM(b.device_num) as totalDevice
        from buy_flow_retain_income_stats a
        JOIN buy_flow_total_income_stats b
            on a.ckapp_id = b.ckapp_id and a.child_ckapp_id = b.child_ckapp_id
            and a.media = b.media and a.ad_item = b.ad_item
                and a.stats_date = b.stats_date
        join buy_flow_activity c
            on a.ckapp_id = c.ckapp_id and a.child_ckapp_id = c.child_ckapp_id
            and a.media = c.media_id and a.ad_item = c.ad_item
        where a.stats_date >= #{startDate}
        and a.stats_date <![CDATA[<=]]> #{endDate}
           GROUP BY 
                <if test="statsDate != -1">
	                a.stats_date,
                </if>
	            <if test="group == 0">
	                a.media
	            </if>
	            <if test="group == 1">
	                c.name
	            </if>
    </select>
	
</mapper>